# task7_VK
Основы безопасности инфраструктуры ДЗ №7 
## 1. Жёстко-зашитые секреты

В исходном playbook два явных секрета:

- строка app_password: "P@ssw0rd123" хранит реальный пароль в открытом виде;;
- файл /etc/sudoers.d/{{app_user}} выдаёт пользователю без-парольный sudo.

Любой, кто увидит репозиторий (Git-история, CI-лог, внешний подрядчик), сразу получает эти данные и может войти на сервер или выполнить команды с `root`-правами.  
После коммита пароль навсегда остаётся в истории Git, а `sudo`-файл открывает хост для эскалации привилегий.

**Исправление:**  
Вынести пароль в `vault.yml`, зашифровать с помощью **Ansible Vault**, а `sudo`-файл удалить или ограничить конкретными командами.

---

## 2. `ufw disable` + `ignore_errors: yes`

Полное отключение `UFW` убирает сетевой экран: хост начинает отвечать на любые порты, упрощая сканирование и brute-force.  
Директива `ignore_errors: yes` скрывает любую ошибку шага: playbook «завершается успешно», даже если `UFW` вовсе не установился.

**Надёжнее:**
- оставить `UFW` включённым и точечно разрешить только `22` и `8080` модулем `community.general.ufw`;
- не отключать отображение ошибок, а перехватывать их через `register:` и `failed_when:` — так playbook остановится при реальной проблеме, и безопасность повысится.

---

## 3. `get_url` без `checksum`

Когда файл скачивается без проверки хэша, атакующий на прокси, зеркале или CDN может подменить архив и встроить вредоносный код (например, web-shell) — контейнер построится уже с заложенной уязвимостью.

**Например:**
```yaml
- name: Download archive with integrity check
  ansible.builtin.get_url:
    url: "{{ download_url }}"
    dest: /tmp/app.tar.gz
    checksum: "sha256:9c1185a5c5e9fc54612808977ee8f548b2258d31a"
```

Если хэш не совпадёт, Ansible сразу оборвёт задачу.

---

## 4. Устаревший образ `nginx:1.18.0`

Версия `1.18.0` вышла в 2020-м и больше не получает патчей CVE: в ней остались опубликованные уязвимости (DoS, потенциальные RCE через модули).

**Решение:**  
Перейти на актуальную стабильную ветку `nginx:1.28.0-alpine` (или тег `nginx:stable-alpine`) и включить в CI ежедневное сканирование образов (`trivy`, `grype`, `docker scout quickview`) с автоматическим созданием Pull Request, когда появляются критические CVE.

---

## 5. Права `0777` на `work_dir`

`0777` означает «чтение-запись-исполнение» для всех пользователей и процессов. Любое приложение в контейнере (или на хосте при RW-монтировании) может изменить HTML-файлы, вставить web-shell или заменить страницу на фишинговую.

**Рекомендуемые права:**  
Только владельцу — RWX, группе — RX, остальным — нет доступа (т.е. `0750`).

**Пример:**
```yaml
- file:
    path: "{{ work_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0750'
```

---

## 6. Секретный токен в `index.html`

В небезопасной версии токен вписан статически в файл, лежащий в Git. После публикации репозитория ключ утечёт безвозвратно — его можно найти через поиск по истории коммитов или в кэше поисковиков.

**Как избежать утечки:**
- хранить токен в секрет-хранилище (например, HashiCorp Vault, AWS Secrets Manager) и выдавать приложениям через API;
- рендерить HTML шаблоном Jinja при деплое, подставляя токен из переменной окружения/Vault’а, а само значение никогда не коммитить;
- на клиенте передавать токен только в `HTTP-Only` cookie или через защищённый заголовок, а не жёстко встраивать в статический контент.

